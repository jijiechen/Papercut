<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Papercut netcore nightly builds</title>

    <!-- Global site tag (gtag.js) - Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-116544183-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'UA-116544183-1');
    </script>
    <script src="https://code.jquery.com/jquery-2.2.4.min.js" integrity="sha256-BbhdlvQf/xTY9gja0Dq3HiwQF8LaCRTXxZKRutelT44=" crossorigin="anonymous"></script>
</head>
<body>
    <h1>Papercut netcore nightly builds</h1>
    <br />
    <h2>Latest Windows archives</h2>
    <ul id="windows-builds">
        <li>Fetching...</li>
    </ul>
    <p><a href="https://ci.appveyor.com/project/Jaben/papercut/history">Checkout more</a></p>
    <br />
    <h2>Latest macOS archives</h2>
    <ul id="osx-builds">
        <li>Fetching...</li>
    </ul>
    <br />
    <h2>Latest Linux archives</h2>
    <ul id="linux-builds">
        <li>Fetching...</li>
    </ul>
    <p><a href="https://travis-ci.org/jijiechen/Papercut/builds">Checkout more</a></p>


    <script>
        function fetchWindowsArchieves(){
            var start = Number(new Date());
            var url = 'https://ci.appveyor.com/api/projects/Jaben/papercut/history?recordsNumber=10&branch=feature/netcore';
            
            $.getJSON(url)
             .then(function(buildData){
                var fetchAllBuilds = buildData.builds
                    .filter(function(b) {return b.status === "success"})
                    .map(function(b){return b.version})
                    .map(function(version){return $.getJSON('https://ci.appveyor.com/api/projects/Jaben/papercut/build/' + version) });
                
                $.when.apply(null, fetchAllBuilds).done(function() {
                        var allBuilds = [].slice.apply(arguments).map(function(respCtx){ return respCtx[0] });
                        var allJobIds = allBuilds
                                .map(function(buildEntry){return buildEntry.build })
                                .filter(function(b){return b.jobs[0].artifactsCount > 0 })
                                .map(function(b){return b.jobs[0].jobId});
                        
                        var fetchAllArtifacts = allJobIds.map(function(jobId){return $.getJSON('https://ci.appveyor.com/api/buildjobs/' + jobId +'/artifacts')});
                        $.when.apply(null, fetchAllArtifacts).done(function() {
                            gtag('event', 'ArtifactsLoaded', {
                                'event_category': 'DataLoad',
                                'event_label': 'Windows',
                                'elapsed': Number(new Date()) - start
                            });

                            var artifactGroups = [].slice.apply(arguments).map(function(respCtx){ return respCtx[0] });
                            artifactGroups.forEach(function(artifactGroup, index)  {
                                artifactGroup.forEach(function(artifact) {
                                    artifact.url = 'https://ci.appveyor.com/api/buildjobs/' + allJobIds[index] + '/artifacts/' + artifact.fileName;
                                });                        
                            });

                            populateArtifacts('windows-builds', artifactGroups);
                        });
                });
            });
        }


        function populateArtifacts(id, artifactGroups){
                var buildList = $('#' + id).empty();
                if(artifactGroups.length < 1){
                    var emptyNotice = 'No recent archieves found.';
                    buildList.append($('<li>').append(emptyNotice));
                    return;
                }

                artifactGroups.forEach(function(artifactGroup) {
                    var li = $('<li>');
                    artifactGroup
                        .sort(function(a1, a2){return a1.fileName.localeCompare(a2.fileName)})
                        .forEach(function(artifact) {
                        var a = $('<a>')
                                    .text(artifact.fileName)
                                    .attr({
                                        href: artifact.url,
                                        title: 'Download ' + artifact.fileName,
                                        target: '_blank'
                                    });
                        a.click(function(){
                            gtag('event', 'Download', {
                                'event_category': $(this).text(),
                                'event_label': $(this).parents('ul').attr('id')
                            });
                        });

                        li.append(a);
                        li.append('&nbsp;&nbsp;');
                    });

                    buildList.append(li);
                });
            }

        /*	This work is licensed under Creative Commons GNU LGPL License.

            License: http://creativecommons.org/licenses/LGPL/2.1/
        Version: 0.9
            Author:  Stefan Goessner/2006
            Web:     http://goessner.net/ 
        */
        function xml2json(xml, tab) {
            var X = {
                toObj: function(xml) {
                    var o = {};
                    if (xml.nodeType==1) {   // element node ..
                        if (xml.attributes.length)   // element with attributes  ..
                        for (var i=0; i<xml.attributes.length; i++)
                            o["@"+xml.attributes[i].nodeName] = (xml.attributes[i].nodeValue||"").toString();
                        if (xml.firstChild) { // element has child nodes ..
                        var textChild=0, cdataChild=0, hasElementChild=false;
                        for (var n=xml.firstChild; n; n=n.nextSibling) {
                            if (n.nodeType==1) hasElementChild = true;
                            else if (n.nodeType==3 && n.nodeValue.match(/[^ \f\n\r\t\v]/)) textChild++; // non-whitespace text
                            else if (n.nodeType==4) cdataChild++; // cdata section node
                        }
                        if (hasElementChild) {
                            if (textChild < 2 && cdataChild < 2) { // structured element with evtl. a single text or/and cdata node ..
                                X.removeWhite(xml);
                                for (var n=xml.firstChild; n; n=n.nextSibling) {
                                    if (n.nodeType == 3)  // text node
                                    o["#text"] = X.escape(n.nodeValue);
                                    else if (n.nodeType == 4)  // cdata node
                                    o["#cdata"] = X.escape(n.nodeValue);
                                    else if (o[n.nodeName]) {  // multiple occurence of element ..
                                    if (o[n.nodeName] instanceof Array)
                                        o[n.nodeName][o[n.nodeName].length] = X.toObj(n);
                                    else
                                        o[n.nodeName] = [o[n.nodeName], X.toObj(n)];
                                    }
                                    else  // first occurence of element..
                                    o[n.nodeName] = X.toObj(n);
                                }
                            }
                            else { // mixed content
                                if (!xml.attributes.length)
                                    o = X.escape(X.innerXml(xml));
                                else
                                    o["#text"] = X.escape(X.innerXml(xml));
                            }
                        }
                        else if (textChild) { // pure text
                            if (!xml.attributes.length)
                                o = X.escape(X.innerXml(xml));
                            else
                                o["#text"] = X.escape(X.innerXml(xml));
                        }
                        else if (cdataChild) { // cdata
                            if (cdataChild > 1)
                                o = X.escape(X.innerXml(xml));
                            else
                                for (var n=xml.firstChild; n; n=n.nextSibling)
                                    o["#cdata"] = X.escape(n.nodeValue);
                        }
                        }
                        if (!xml.attributes.length && !xml.firstChild) o = null;
                    }
                    else if (xml.nodeType==9) { // document.node
                        o = X.toObj(xml.documentElement);
                    }
                    else
                        alert("unhandled node type: " + xml.nodeType);
                    return o;
                },
                toJson: function(o, name, ind) {
                    var json = name ? ("\""+name+"\"") : "";
                    if (o instanceof Array) {
                        for (var i=0,n=o.length; i<n; i++)
                        o[i] = X.toJson(o[i], "", ind+"\t");
                        json += (name?":[":"[") + (o.length > 1 ? ("\n"+ind+"\t"+o.join(",\n"+ind+"\t")+"\n"+ind) : o.join("")) + "]";
                    }
                    else if (o == null)
                        json += (name&&":") + "null";
                    else if (typeof(o) == "object") {
                        var arr = [];
                        for (var m in o)
                        arr[arr.length] = X.toJson(o[m], m, ind+"\t");
                        json += (name?":{":"{") + (arr.length > 1 ? ("\n"+ind+"\t"+arr.join(",\n"+ind+"\t")+"\n"+ind) : arr.join("")) + "}";
                    }
                    else if (typeof(o) == "string")
                        json += (name&&":") + "\"" + o.toString() + "\"";
                    else
                        json += (name&&":") + o.toString();
                    return json;
                },
                innerXml: function(node) {
                    var s = ""
                    if ("innerHTML" in node)
                        s = node.innerHTML;
                    else {
                        var asXml = function(n) {
                        var s = "";
                        if (n.nodeType == 1) {
                            s += "<" + n.nodeName;
                            for (var i=0; i<n.attributes.length;i++)
                                s += " " + n.attributes[i].nodeName + "=\"" + (n.attributes[i].nodeValue||"").toString() + "\"";
                            if (n.firstChild) {
                                s += ">";
                                for (var c=n.firstChild; c; c=c.nextSibling)
                                    s += asXml(c);
                                s += "</"+n.nodeName+">";
                            }
                            else
                                s += "/>";
                        }
                        else if (n.nodeType == 3)
                            s += n.nodeValue;
                        else if (n.nodeType == 4)
                            s += "<![CDATA[" + n.nodeValue + "]]>";
                        return s;
                        };
                        for (var c=node.firstChild; c; c=c.nextSibling)
                        s += asXml(c);
                    }
                    return s;
                },
                escape: function(txt) {
                    return txt.replace(/[\\]/g, "\\\\")
                            .replace(/[\"]/g, '\\"')
                            .replace(/[\n]/g, '\\n')
                            .replace(/[\r]/g, '\\r');
                },
                removeWhite: function(e) {
                    e.normalize();
                    for (var n = e.firstChild; n; ) {
                        if (n.nodeType == 3) {  // text node
                        if (!n.nodeValue.match(/[^ \f\n\r\t\v]/)) { // pure whitespace text node
                            var nxt = n.nextSibling;
                            e.removeChild(n);
                            n = nxt;
                        }
                        else
                            n = n.nextSibling;
                        }
                        else if (n.nodeType == 1) {  // element node
                        X.removeWhite(n);
                        n = n.nextSibling;
                        }
                        else                      // any other node
                        n = n.nextSibling;
                    }
                    return e;
                }
            };
            if (xml.nodeType == 9) // document node
                xml = xml.documentElement;
            var json = X.toJson(X.toObj(X.removeWhite(xml)), xml.nodeName, "\t");
            return "{\n" + tab + (tab ? json.replace(/\t/g, tab) : json.replace(/\t|\n/g, "")) + "\n}";
        }



        function fetchArchievesFromAzure(osName){
            var start = Number(new Date());

            $.get('https://papercutartifacts.blob.core.windows.net/prereleases/?comp=list&prefix=' + osName + '&maxresults=100&include=metadata&&api-version=2017-07-29')
            .then(function(doc, status, xhr) {
                gtag('event', 'ArtifactsLoaded', {
                    'event_category': 'DataLoad',
                    'event_label': osName,
                    'elapsed': Number(new Date()) - start
                });

                if(status !== 'success'){ return; }
                var json = xml2json(xhr.responseXML, '');
                var blobs = $.parseJSON(json).EnumerationResults.Blobs;
                blobs = blobs ? blobs.Blob : [];

                var artifacts = blobs.map(function(rawBlob) {
                    // name looks like: linux/5.1.12-netcore/PapercutDesktop.linux.5.1.12-netcore.zip 
                    var firstSlash = rawBlob.Name.indexOf('/');
                    var lastSlash = rawBlob.Name.lastIndexOf('/');

                    return {   
                        build: rawBlob.Name.substr(firstSlash + 1, lastSlash - firstSlash - 1),
                        fileName: rawBlob.Name.substr(lastSlash + 1),
                        url: rawBlob.Url,
                        size: rawBlob.Size
                    };
                })
                .sort(function(a1, a2){
                    function version(a){
                        return parseInt(a.build.replace(/\./g, ''));
                    }

                    return version(a2) - version(a1);
                });

                var  allArtifacts = artifacts.slice(0, Math.max(10, artifacts.length))
                                            .reduce(function(allBlobs, item) {
                                                (allBlobs[item.build] = allBlobs[item.build] || []).push(item);
                                                return allBlobs;
                                            }, {});
                var artifactItems = [];
                for(var key in allArtifacts){
                    if(allArtifacts.hasOwnProperty(key)){
                        artifactItems.push(allArtifacts[key]);
                    }
                }

                populateArtifacts(osName + '-builds', artifactItems);
            });
        }

        fetchWindowsArchieves();
        fetchArchievesFromAzure('linux');
        fetchArchievesFromAzure('osx');

    </script>

</body>
</html>